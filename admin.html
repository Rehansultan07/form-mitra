<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin - DigiMitr</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
        function checkAdminAuth() {
            const masterPin = "Rehan@786";
            if (sessionStorage.getItem("adminLoggedIn") !== "true") {
                let pin = prompt("Admin Security PIN:");
                if (pin === masterPin) {
                    sessionStorage.setItem("adminLoggedIn", "true");
                } else {
                    alert("Galat PIN!");
                    window.location.href = "index.html";
                }
            }
        }
        checkAdminAuth();
        function logoutAdmin() { sessionStorage.removeItem("adminLoggedIn"); window.location.reload(); }
    </script>

    <style>
        :root { --blue: #0074D9; --navy: #001f3f; --bg: #f4f7f9; --red: #e74c3c; --gold: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: #333; }
        .admin-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border-top: 4px solid var(--blue); }
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; font-size: 14px; }
        .btn { background: var(--blue); color: white; border: none; padding: 14px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
        .btn-gold { background: var(--gold); color: #000; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: left; font-size: 13px; }
        .btn-del { background: var(--red); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 11px; }
    </style>
</head>
<body>

<div class="header-flex">
    <h1><i class="fas fa-user-shield"></i> DigiMitr Admin</h1>
    <button onclick="logoutAdmin()" style="cursor:pointer">Logout</button>
</div>

<div class="admin-card" style="border-top-color: var(--gold);">
    <h2><i class="fas fa-gift"></i> Active Affiliate Popup</h2>
    <div class="form-grid">
        <input type="text" id="popTitle" placeholder="Offer Title (e.g. SBI Credit Card)">
        <input type="text" id="popText" placeholder="Short Desc (e.g. Free for Lifetime)">
        <input type="text" id="popLink" placeholder="Affiliate Link">
    </div>
    <button class="btn btn-gold" onclick="setPopupOffer()">Set Live Popup <i class="fas fa-magic"></i></button>
</div>

<div class="admin-card">
    <h2><i class="fas fa-rss"></i> Live Updates</h2>
    <div class="form-grid">
        <select id="updateType">
            <option value="results">Results</option>
            <option value="admitcards">Admit Cards</option>
            <option value="forms">Online Forms</option>
            <option value="pan">PAN Card</option>
            <option value="aadhaar">Aadhaar</option>
        </select>
        <input type="text" id="updateTitle" placeholder="Update Title">
        <input type="text" id="updateLink" placeholder="Official Link">
    </div>
    <button class="btn" onclick="postToFirebase()">Post Update</button>
</div>

<div class="admin-card">
    <h2><i class="fas fa-tasks"></i> Manage Content</h2>
    <table>
        <thead><tr><th>Category</th><th>Title</th><th>Action</th></tr></thead>
        <tbody id="linksTableBody"></tbody>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyA38pu8oY78SaLciR3JzwdwC4avpdEHBg4", 
        authDomain: "formmitra-auth.firebaseapp.com", 
        projectId: "formmitra-auth", 
        databaseURL: "https://formmitra-auth-default-rtdb.asia-southeast1.firebasedatabase.app" 
    };
    const app = initializeApp(firebaseConfig); const db = getDatabase(app);

    // FIX: Function to Set Popup Offer
    window.setPopupOffer = () => {
        const title = document.getElementById('popTitle').value;
        const text = document.getElementById('popText').value;
        const link = document.getElementById('popLink').value;
        if(title && link) {
            set(ref(db, 'active_popup'), { title, text, link, active: true }).then(() => {
                alert("Popup Live Ho Gaya!");
                location.reload();
            });
        } else { alert("Title aur Link bhariye!"); }
    };

    window.postToFirebase = () => {
        const type = document.getElementById('updateType').value;
        const title = document.getElementById('updateTitle').value;
        const link = document.getElementById('updateLink').value;
        if(title && link) {
            push(ref(db, 'services/' + type), { title, link, timestamp: Date.now() });
            alert("Update Posted!");
            location.reload();
        }
    };

    const categories = ['results', 'admitcards', 'forms', 'pan', 'aadhaar'];
    const tableBody = document.getElementById('linksTableBody');

    categories.forEach(cat => {
        onValue(ref(db, 'services/' + cat), (snapshot) => {
            const data = snapshot.val();
            if(data) {
                Object.keys(data).forEach(id => {
                    tableBody.innerHTML += `<tr>
                        <td>${cat.toUpperCase()}</td>
                        <td>${data[id].title}</td>
                        <td><button class="btn-del" onclick="deleteItem('${cat}', '${id}')">Delete</button></td>
                    </tr>`;
                });
            }
        }, { onlyOnce: true });
    });

    window.deleteItem = (cat, id) => {
        if(confirm("Delete?")) {
            remove(ref(db, 'services/' + cat + '/' + id)).then(() => location.reload());
        }
    };
</script>
</body>
</html>
